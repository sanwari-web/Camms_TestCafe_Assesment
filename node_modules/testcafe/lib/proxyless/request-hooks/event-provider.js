"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const testcafe_hammerhead_1 = require("testcafe-hammerhead");
const pipeline_context_1 = __importDefault(require("./pipeline-context"));
const event_factory_1 = __importDefault(require("./event-factory"));
const string_1 = require("../utils/string");
const connection_1 = __importDefault(require("../../browser/connection"));
class ProxylessRequestHookEventProvider extends testcafe_hammerhead_1.RequestHookEventProvider {
    constructor(browserId) {
        super();
        this._pipelineContexts = {};
        this._eventFactories = {};
        this._browserId = browserId;
    }
    _createPipelineContext(requestId) {
        const pipelineContext = new pipeline_context_1.default(requestId);
        this._pipelineContexts[requestId] = pipelineContext;
        return pipelineContext;
    }
    _getSessionId() {
        const browserConnection = connection_1.default.getById(this._browserId);
        const currentTestRun = browserConnection.getCurrentTestRun();
        return (currentTestRun === null || currentTestRun === void 0 ? void 0 : currentTestRun.id) || '';
    }
    _createEventFactory(event) {
        const sessionId = this._getSessionId();
        const eventFactory = new event_factory_1.default(event, sessionId);
        this._eventFactories[event.networkId] = eventFactory;
        return eventFactory;
    }
    getPipelineContext(requestId) {
        return this._pipelineContexts[requestId];
    }
    _getEventFactory(requestId) {
        return this._eventFactories[requestId];
    }
    _getContextData(event) {
        const pipelineContext = this.getPipelineContext(event.networkId);
        const eventFactory = this._getEventFactory(event.networkId);
        return { pipelineContext, eventFactory };
    }
    static _hasResponseWithBody(context) {
        return context.onResponseEventData.some((eventData) => eventData.opts.includeBody);
    }
    static async _setResponseBody({ pipelineContext, resourceBody, eventFactory, event, client }) {
        if (resourceBody === null || resourceBody === void 0 ? void 0 : resourceBody.length) {
            eventFactory.setResponseBody(resourceBody);
            return;
        }
        const hasOnResponseWithBody = ProxylessRequestHookEventProvider._hasResponseWithBody(pipelineContext);
        if (!hasOnResponseWithBody)
            return;
        const responseObj = await client.Fetch.getResponseBody({ requestId: event.requestId });
        const responseBody = (0, string_1.getResponseAsBuffer)(responseObj);
        eventFactory.setResponseBody(responseBody);
    }
    cleanUp(requestId) {
        delete this._pipelineContexts[requestId];
        delete this._eventFactories[requestId];
    }
    async onRequest(event) {
        if (!this.hasRequestEventListeners())
            return;
        const pipelineContext = this._createPipelineContext(event.networkId);
        const eventFactory = this._createEventFactory(event);
        pipelineContext.setRequestOptions(eventFactory);
        await pipelineContext.onRequestHookRequest(this, eventFactory);
    }
    async onResponse(event, resourceBody, client) {
        let modified = false;
        if (!this.hasRequestEventListeners()) {
            this.cleanUp(event.networkId);
            return modified;
        }
        const { pipelineContext, eventFactory } = this._getContextData(event);
        eventFactory.update(event);
        await pipelineContext.onRequestHookConfigureResponse(this, eventFactory);
        if (eventFactory.headersModified)
            modified = true;
        await ProxylessRequestHookEventProvider._setResponseBody({
            pipelineContext,
            resourceBody,
            eventFactory,
            event,
            client,
        });
        await Promise.all(pipelineContext.onResponseEventData.map(async (eventData) => {
            await pipelineContext.onRequestHookResponse(this, eventFactory, eventData.rule, eventData.opts);
        }));
        this.cleanUp(event.networkId);
        return modified;
    }
}
exports.default = ProxylessRequestHookEventProvider;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnQtcHJvdmlkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvcHJveHlsZXNzL3JlcXVlc3QtaG9va3MvZXZlbnQtcHJvdmlkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSw2REFBb0Y7QUFHcEYsMEVBQTBEO0FBRTFELG9FQUFvRDtBQUVwRCw0Q0FBc0Q7QUFDdEQsMEVBQXlEO0FBT3pELE1BQXFCLGlDQUFrQyxTQUFRLDhDQUF3QjtJQUtuRixZQUFhLFNBQWlCO1FBQzFCLEtBQUssRUFBRSxDQUFDO1FBRVIsSUFBSSxDQUFDLGlCQUFpQixHQUFHLEVBQUUsQ0FBQztRQUM1QixJQUFJLENBQUMsZUFBZSxHQUFLLEVBQUUsQ0FBQztRQUM1QixJQUFJLENBQUMsVUFBVSxHQUFVLFNBQVMsQ0FBQztJQUN2QyxDQUFDO0lBRU8sc0JBQXNCLENBQUUsU0FBaUI7UUFDN0MsTUFBTSxlQUFlLEdBQUcsSUFBSSwwQkFBd0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUVoRSxJQUFJLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDLEdBQUcsZUFBZSxDQUFDO1FBRXBELE9BQU8sZUFBZSxDQUFDO0lBQzNCLENBQUM7SUFFTyxhQUFhO1FBQ2pCLE1BQU0saUJBQWlCLEdBQUcsb0JBQWlCLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQXNCLENBQUM7UUFDMUYsTUFBTSxjQUFjLEdBQU0saUJBQWlCLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUVoRSxPQUFPLENBQUEsY0FBYyxhQUFkLGNBQWMsdUJBQWQsY0FBYyxDQUFFLEVBQUUsS0FBSSxFQUFFLENBQUM7SUFDcEMsQ0FBQztJQUVPLG1CQUFtQixDQUFFLEtBQXlCO1FBQ2xELE1BQU0sU0FBUyxHQUFNLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUMxQyxNQUFNLFlBQVksR0FBRyxJQUFJLHVCQUFxQixDQUFDLEtBQUssRUFBRSxTQUFTLENB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WUFBWSxFQUFFLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUV0RSxZQUFZLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRTNCLE1BQU0sZUFBZSxDQUFDLDhCQUE4QixDQUFDLElBQUksRUFBRSxZQUFZLENBQUMsQ0FBQztRQUV6RSxJQUFJLFlBQVksQ0FBQyxlQUFlO1lBQzVCLFFBQVEsR0FBRyxJQUFJLENBQUM7UUFFcEIsTUFBTSxpQ0FBaUMsQ0FBQyxnQkFBZ0IsQ0FBQztZQUNyRCxlQUFlO1lBQ2YsWUFBWTtZQUNaLFlBQVk7WUFDWixLQUFLO1lBQ0wsTUFBTTtTQUNULENBQUMsQ0FBQztRQUVILE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsbUJBQW1CLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBQyxTQUFTLEVBQUMsRUFBRTtZQUN4RSxNQUFNLGVBQWUsQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLEVBQUUsWUFBWSxFQUFFLFNBQVMsQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFSixJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxTQUFtQixDQUFDLENBQUM7UUFFeEMsT0FBTyxRQUFRLENBQUM7SUFDcEIsQ0FBQztDQUNKO0FBOUhELG9EQThIQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9uUmVzcG9uc2VFdmVudERhdGEsIFJlcXVlc3RIb29rRXZlbnRQcm92aWRlciB9IGZyb20gJ3Rlc3RjYWZlLWhhbW1lcmhlYWQnO1xuaW1wb3J0IFByb3RvY29sIGZyb20gJ2RldnRvb2xzLXByb3RvY29sJztcbmltcG9ydCBSZXF1ZXN0UGF1c2VkRXZlbnQgPSBQcm90b2NvbC5GZXRjaC5SZXF1ZXN0UGF1c2VkRXZlbnQ7XG5pbXBvcnQgUHJveHlsZXNzUGlwZWxpbmVDb250ZXh0IGZyb20gJy4vcGlwZWxpbmUtY29udGV4dCc7XG5pbXBvcnQgeyBEaWN0aW9uYXJ5IH0gZnJvbSAnLi4vLi4vY29uZmlndXJhdGlvbi9pbnRlcmZhY2VzJztcbmltcG9ydCBQcm94eWxlc3NFdmVudEZhY3RvcnkgZnJvbSAnLi9ldmVudC1mYWN0b3J5JztcbmltcG9ydCB7IFByb3RvY29sQXBpIH0gZnJvbSAnY2hyb21lLXJlbW90ZS1pbnRlcmZhY2UnO1xuaW1wb3J0IHsgZ2V0UmVzcG9uc2VBc0J1ZmZlciB9IGZyb20gJy4uL3V0aWxzL3N0cmluZyc7XG5pbXBvcnQgQnJvd3NlckNvbm5lY3Rpb24gZnJvbSAnLi4vLi4vYnJvd3Nlci9jb25uZWN0aW9uJztcblxuaW50ZXJmYWNlIENvbnRleHREYXRhIHtcbiAgICBwaXBlbGluZUNvbnRleHQ6IFByb3h5bGVzc1BpcGVsaW5lQ29udGV4dDtcbiAgICBldmVudEZhY3Rvcnk6IFByb3h5bGVzc0V2ZW50RmFjdG9yeTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUHJveHlsZXNzUmVxdWVzdEhvb2tFdmVudFByb3ZpZGVyIGV4dGVuZHMgUmVxdWVzdEhvb2tFdmVudFByb3ZpZGVyIHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9waXBlbGluZUNvbnRleHRzOiBEaWN0aW9uYXJ5PFByb3h5bGVzc1BpcGVsaW5lQ29udGV4dD47XG4gICAgcHJpdmF0ZSByZWFkb25seSBfZXZlbnRGYWN0b3JpZXM6IERpY3Rpb25hcnk8UHJveHlsZXNzRXZlbnRGYWN0b3J5PjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9icm93c2VySWQ6IHN0cmluZztcblxuICAgIGNvbnN0cnVjdG9yIChicm93c2VySWQ6IHN0cmluZykge1xuICAgICAgICBzdXBlcigpO1xuXG4gICAgICAgIHRoaXMuX3BpcGVsaW5lQ29udGV4dHMgPSB7fTtcbiAgICAgICAgdGhpcy5fZXZlbnRGYWN0b3JpZXMgICA9IHt9O1xuICAgICAgICB0aGlzLl9icm93c2VySWQgICAgICAgID0gYnJvd3NlcklkO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2NyZWF0ZVBpcGVsaW5lQ29udGV4dCAocmVxdWVzdElkOiBzdHJpbmcpOiBQcm94eWxlc3NQaXBlbGluZUNvbnRleHQge1xuICAgICAgICBjb25zdCBwaXBlbGluZUNvbnRleHQgPSBuZXcgUHJveHlsZXNzUGlwZWxpbmVDb250ZXh0KHJlcXVlc3RJZCk7XG5cbiAgICAgICAgdGhpcy5fcGlwZWxpbmVDb250ZXh0c1tyZXF1ZXN0SWRdID0gcGlwZWxpbmVDb250ZXh0O1xuXG4gICAgICAgIHJldHVybiBwaXBlbGluZUNvbnRleHQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZ2V0U2Vzc2lvbklkICgpOiBzdHJpbmcge1xuICAgICAgICBjb25zdCBicm93c2VyQ29ubmVjdGlvbiA9IEJyb3dzZXJDb25uZWN0aW9uLmdldEJ5SWQodGhpcy5fYnJvd3NlcklkKSBhcyBCcm93c2VyQ29ubmVjdGlvbjtcbiAgICAgICAgY29uc3QgY3VycmVudFRlc3RSdW4gICAgPSBicm93c2VyQ29ubmVjdGlvbi5nZXRDdXJyZW50VGVzdFJ1bigpO1xuXG4gICAgICAgIHJldHVybiBjdXJyZW50VGVzdFJ1bj8uaWQgfHwgJyc7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfY3JlYXRlRXZlbnRGYWN0b3J5IChldmVudDogUmVxdWVzdFBhdXNlZEV2ZW50KTogUHJveHlsZXNzRXZlbnRGYWN0b3J5IHtcbiAgICAgICAgY29uc3Qgc2Vzc2lvbklkICAgID0gdGhpcy5fZ2V0U2Vzc2lvbklkKCk7XG4gICAgICAgIGNvbnN0IGV2ZW50RmFjdG9yeSA9IG5ldyBQcm94eWxlc3NFdmVudEZhY3RvcnkoZXZlbnQsIHNlc3Npb25JZCk7XG5cbiAgICAgICAgdGhpcy5fZXZlbnRGYWN0b3JpZXNbZXZlbnQubmV0d29ya0lkIGFzIHN0cmluZ10gPSBldmVudEZhY3Rvcnk7XG5cbiAgICAgICAgcmV0dXJuIGV2ZW50RmFjdG9yeTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0UGlwZWxpbmVDb250ZXh0IChyZXF1ZXN0SWQ6IHN0cmluZyk6IFByb3h5bGVzc1BpcGVsaW5lQ29udGV4dCB7XG4gICAgICAgIHJldHVybiB0aGlzLl9waXBlbGluZUNvbnRleHRzW3JlcXVlc3RJZF07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZ2V0RXZlbnRGYWN0b3J5IChyZXF1ZXN0SWQ6IHN0cmluZyk6IFByb3h5bGVzc0V2ZW50RmFjdG9yeSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9ldmVudEZhY3Rvcmllc1tyZXF1ZXN0SWRdO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2dldENvbnRleHREYXRhIChldmVudDogUmVxdWVzdFBhdXNlZEV2ZW50KTogQ29udGV4dERhdGEge1xuICAgICAgICBjb25zdCBwaXBlbGluZUNvbnRleHQgPSB0aGlzLmdldFBpcGVsaW5lQ29udGV4dChldmVudC5uZXR3b3JrSWQgYXMgc3RyaW5nKTtcbiAgICAgICAgY29uc3QgZXZlbnRGYWN0b3J5ICAgID0gdGhpcy5fZ2V0RXZlbnRGYWN0b3J5KGV2ZW50Lm5ldHdvcmtJZCBhcyBzdHJpbmcpO1xuXG4gICAgICAgIHJldHVybiB7IHBpcGVsaW5lQ29udGV4dCwgZXZlbnRGYWN0b3J5IH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgX2hhc1Jlc3BvbnNlV2l0aEJvZHkgKGNvbnRleHQ6IFByb3h5bGVzc1BpcGVsaW5lQ29udGV4dCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gY29udGV4dC5vblJlc3BvbnNlRXZlbnREYXRhLnNvbWUoKGV2ZW50RGF0YTogT25SZXNwb25zZUV2ZW50RGF0YSkgPT4gZXZlbnREYXRhLm9wdHMuaW5jbHVkZUJvZHkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIGFzeW5jIF9zZXRSZXNwb25zZUJvZHkgKHsgcGlwZWxpbmVDb250ZXh0LCByZXNvdXJjZUJvZHksIGV2ZW50RmFjdG9yeSwgZXZlbnQsIGNsaWVudCB9OiB7IHBpcGVsaW5lQ29udGV4dDogUHJveHlsZXNzUGlwZWxpbmVDb250ZXh0LCByZXNvdXJjZUJvZHk6IEJ1ZmZlciB8IG51bGwsIGV2ZW50RmFjdG9yeTogUHJveHlsZXNzRXZlbnRGYWN0b3J5LCBldmVudDogUmVxdWVzdFBhdXNlZEV2ZW50LCBjbGllbnQ6IFByb3RvY29sQXBpIH0pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgaWYgKHJlc291cmNlQm9keT8ubGVuZ3RoKSB7XG4gICAgICAgICAgICBldmVudEZhY3Rvcnkuc2V0UmVzcG9uc2VCb2R5KHJlc291cmNlQm9keSk7XG5cbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG5cbiAgICAgICAgY29uc3QgaGFzT25SZXNwb25zZVdpdGhCb2R5ID0gUHJveHlsZXNzUmVxdWVzdEhvb2tFdmVudFByb3ZpZGVyLl9oYXNSZXNwb25zZVdpdGhCb2R5KHBpcGVsaW5lQ29udGV4dCk7XG5cbiAgICAgICAgaWYgKCFoYXNPblJlc3BvbnNlV2l0aEJvZHkpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgY29uc3QgcmVzcG9uc2VPYmogID0gYXdhaXQgY2xpZW50LkZldGNoLmdldFJlc3BvbnNlQm9keSh7IHJlcXVlc3RJZDogZXZlbnQucmVxdWVzdElkIH0pO1xuICAgICAgICBjb25zdCByZXNwb25zZUJvZHkgPSBnZXRSZXNwb25zZUFzQnVmZmVyKHJlc3BvbnNlT2JqKTtcblxuICAgICAgICBldmVudEZhY3Rvcnkuc2V0UmVzcG9uc2VCb2R5KHJlc3BvbnNlQm9keSk7XG4gICAgfVxuXG4gICAgcHVibGljIGNsZWFuVXAgKHJlcXVlc3RJZDogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIGRlbGV0ZSB0aGlzLl9waXBlbGluZUNvbnRleHRzW3JlcXVlc3RJZF07XG4gICAgICAgIGRlbGV0ZSB0aGlzLl9ldmVudEZhY3Rvcmllc1tyZXF1ZXN0SWRdO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBvblJlcXVlc3QgKGV2ZW50OiBSZXF1ZXN0UGF1c2VkRXZlbnQpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgaWYgKCF0aGlzLmhhc1JlcXVlc3RFdmVudExpc3RlbmVycygpKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGNvbnN0IHBpcGVsaW5lQ29udGV4dCA9IHRoaXMuX2NyZWF0ZVBpcGVsaW5lQ29udGV4dChldmVudC5uZXR3b3JrSWQgYXMgc3RyaW5nKTtcbiAgICAgICAgY29uc3QgZXZlbnRGYWN0b3J5ICAgID0gdGhpcy5fY3JlYXRlRXZlbnRGYWN0b3J5KGV2ZW50KTtcblxuICAgICAgICBwaXBlbGluZUNvbnRleHQuc2V0UmVxdWVzdE9wdGlvbnMoZXZlbnRGYWN0b3J5KTtcblxuICAgICAgICBhd2FpdCBwaXBlbGluZUNvbnRleHQub25SZXF1ZXN0SG9va1JlcXVlc3QodGhpcywgZXZlbnRGYWN0b3J5KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgb25SZXNwb25zZSAoZXZlbnQ6IFJlcXVlc3RQYXVzZWRFdmVudCwgcmVzb3VyY2VCb2R5OiBCdWZmZXIgfCBudWxsLCBjbGllbnQ6IFByb3RvY29sQXBpKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIGxldCBtb2RpZmllZCA9IGZhbHNlO1xuXG4gICAgICAgIGlmICghdGhpcy5oYXNSZXF1ZXN0RXZlbnRMaXN0ZW5lcnMoKSkge1xuICAgICAgICAgICAgdGhpcy5jbGVhblVwKGV2ZW50Lm5ldHdvcmtJZCBhcyBzdHJpbmcpO1xuXG4gICAgICAgICAgICByZXR1cm4gbW9kaWZpZWQ7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB7IHBpcGVsaW5lQ29udGV4dCwgZXZlbnRGYWN0b3J5IH0gPSB0aGlzLl9nZXRDb250ZXh0RGF0YShldmVudCk7XG5cbiAgICAgICAgZXZlbnRGYWN0b3J5LnVwZGF0ZShldmVudCk7XG5cbiAgICAgICAgYXdhaXQgcGlwZWxpbmVDb250ZXh0Lm9uUmVxdWVzdEhvb2tDb25maWd1cmVSZXNwb25zZSh0aGlzLCBldmVudEZhY3RvcnkpO1xuXG4gICAgICAgIGlmIChldmVudEZhY3RvcnkuaGVhZGVyc01vZGlmaWVkKVxuICAgICAgICAgICAgbW9kaWZpZWQgPSB0cnVlO1xuXG4gICAgICAgIGF3YWl0IFByb3h5bGVzc1JlcXVlc3RIb29rRXZlbnRQcm92aWRlci5fc2V0UmVzcG9uc2VCb2R5KHtcbiAgICAgICAgICAgIHBpcGVsaW5lQ29udGV4dCxcbiAgICAgICAgICAgIHJlc291cmNlQm9keSxcbiAgICAgICAgICAgIGV2ZW50RmFjdG9yeSxcbiAgICAgICAgICAgIGV2ZW50LFxuICAgICAgICAgICAgY2xpZW50LFxuICAgICAgICB9KTtcblxuICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChwaXBlbGluZUNvbnRleHQub25SZXNwb25zZUV2ZW50RGF0YS5tYXAoYXN5bmMgZXZlbnREYXRhID0+IHtcbiAgICAgICAgICAgIGF3YWl0IHBpcGVsaW5lQ29udGV4dC5vblJlcXVlc3RIb29rUmVzcG9uc2UodGhpcywgZXZlbnRGYWN0b3J5LCBldmVudERhdGEucnVsZSwgZXZlbnREYXRhLm9wdHMpO1xuICAgICAgICB9KSk7XG5cbiAgICAgICAgdGhpcy5jbGVhblVwKGV2ZW50Lm5ldHdvcmtJZCBhcyBzdHJpbmcpO1xuXG4gICAgICAgIHJldHVybiBtb2RpZmllZDtcbiAgICB9XG59XG4iXX0=